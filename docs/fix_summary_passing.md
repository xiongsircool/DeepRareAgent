# å¯¹è¯æ€»ç»“ä¼ é€’é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

MDTå­å›¾æ— æ³•æ¥æ”¶åˆ°ä¸»å›¾çš„å¯¹è¯æ€»ç»“ï¼ˆ`summary_with_dialogue`ï¼‰ï¼Œå¯¼è‡´ä¸“å®¶ç»„åœ¨è¯Šæ–­æ—¶ç¼ºå°‘é¢„è¯Šæ–­é˜¶æ®µçš„å¯¹è¯ä¸Šä¸‹æ–‡ã€‚

## æ ¹æœ¬åŸå› 

### é—®é¢˜1ï¼šCommandæ›´æ–°æ—¶åºé—®é¢˜

`trigger_deep_diagnosis` å·¥å…·ä½¿ç”¨ `Command(update={"start_diagnosis": True}, graph=Command.PARENT)` ç›´æ¥æ›´æ–°**çˆ¶å›¾ï¼ˆä¸»å›¾ï¼‰çš„çŠ¶æ€**ï¼Œè€Œä¸æ˜¯æ›´æ–° agent è¿”å›çš„ resultã€‚

å¯¼è‡´çš„æ‰§è¡Œæµç¨‹ï¼š
1. Agent è°ƒç”¨ `trigger_deep_diagnosis` å·¥å…·
2. å·¥å…·é€šè¿‡ `Command.PARENT` æ›´æ–°ä¸»å›¾çŠ¶æ€ï¼š`start_diagnosis = True`
3. ä¸»å›¾æ£€æµ‹åˆ° `start_diagnosis=True`ï¼Œè·¯ç”±åˆ° MDT
4. **ä½†æ˜¯**é¢„è¯Šæ–­èŠ‚ç‚¹çš„ `result.get('start_diagnosis')` ä»ä¸º `False`
5. ç”Ÿæˆæ€»ç»“çš„æ¡ä»¶ `if result.get('start_diagnosis', False) and not state.get('start_diagnosis', False):` ä¸æ»¡è¶³
6. å¯¹è¯æ€»ç»“ç”Ÿæˆä»£ç **æ ¹æœ¬æ²¡æœ‰æ‰§è¡Œ**
7. MDT æ”¶åˆ°ç©ºçš„ `summary_with_dialogue`

### é—®é¢˜2ï¼šé”™è¯¯çš„ç”Ÿæˆæ—¶æœº

åŸè®¾è®¡æ˜¯åœ¨é¢„è¯Šæ–­èŠ‚ç‚¹ä¸­ç”Ÿæˆå¯¹è¯æ€»ç»“ï¼Œä½†ç”±äº Command çš„æ›´æ–°æœºåˆ¶ï¼Œé¢„è¯Šæ–­èŠ‚ç‚¹æ— æ³•æ•è·çŠ¶æ€å˜åŒ–ã€‚

## è§£å†³æ–¹æ¡ˆ

### æ¶æ„è°ƒæ•´

å°†å¯¹è¯æ€»ç»“çš„ç”Ÿæˆä»**é¢„è¯Šæ–­èŠ‚ç‚¹**ç§»åˆ°**ä¸»å›¾çš„è·¯ç”±é˜¶æ®µ**ã€‚

### æ–°å¢èŠ‚ç‚¹ï¼š`prepare_for_mdt_node`

åœ¨ä¸»å›¾ä¸­æ·»åŠ ä¸€ä¸ªä¸­é—´èŠ‚ç‚¹ï¼Œä¸“é—¨è´Ÿè´£åœ¨è¿›å…¥ MDT ä¹‹å‰ç”Ÿæˆå¯¹è¯æ€»ç»“ï¼š

```python
async def prepare_for_mdt_node(state: MainGraphState):
    """
    åœ¨è¿›å…¥MDTä¹‹å‰çš„å‡†å¤‡èŠ‚ç‚¹ï¼šç”Ÿæˆå¯¹è¯æ€»ç»“
    
    è§£å†³çš„é—®é¢˜ï¼š
    trigger_deep_diagnosis å·¥å…·é€šè¿‡ Command.PARENT ç›´æ¥æ›´æ–°ä¸»å›¾çŠ¶æ€ï¼Œ
    å¯¼è‡´é¢„è¯Šæ–­èŠ‚ç‚¹çš„ result ä¸­æ— æ³•æ•è· start_diagnosis çš„å˜åŒ–ã€‚
    """
    # 1. æ£€æŸ¥æ˜¯å¦å·²æœ‰æ€»ç»“
    existing_summary = state.get('summary_with_dialogue', '')
    if existing_summary:
        return {}
    
    # 2. æå–å¯¹è¯å†å²
    # 3. è°ƒç”¨ LLM ç”Ÿæˆæ€»ç»“
    # 4. è¿”å›æ›´æ–°åçš„çŠ¶æ€
```

### æ–°çš„ä¸»å›¾æµç¨‹

```
START 
  â†“
é¢„è¯Šæ–­èŠ‚ç‚¹ (prediagnosis)
  â†“
æ¡ä»¶åˆ¤æ–­ (route_after_prediagnosis)
  â”œâ”€ start_diagnosis=True â†’ å‡†å¤‡MDTèŠ‚ç‚¹ (prepare_mdt) [DONE] æ–°å¢
  â””â”€ start_diagnosis=False â†’ END
                               â†“
                          MDTå­å›¾ (mdt_diagnosis)
                               â†“
                          æ±‡æ€»èŠ‚ç‚¹ (summary)
                               â†“
                              END
```

### é¢„è¯Šæ–­èŠ‚ç‚¹ç®€åŒ–

ç§»é™¤å¯¹è¯æ€»ç»“ç”Ÿæˆé€»è¾‘ï¼Œåªä¿ç•™è§¦å‘æ£€æµ‹å’ŒUIæç¤ºï¼š

```python
# ç®€åŒ–åçš„é€»è¾‘
if result.get('start_diagnosis', False) and not state.get('start_diagnosis', False):
    print("\nğŸš€ [PreDiag] æ£€æµ‹åˆ°æ·±åº¦è¯Šæ–­è§¦å‘")
    # åªæ·»åŠ UIæç¤ºï¼Œä¸ç”Ÿæˆæ€»ç»“

return {
    'messages': [final_ai_message] if final_ai_message else [],
    'patient_info': result.get('patient_info', state.get('patient_info', {})),
    'summary_with_dialogue': state.get('summary_with_dialogue', ''),  # ä¿æŒåŸå€¼
    'start_diagnosis': result.get('start_diagnosis', state.get('start_diagnosis', False))
}
```

## ä¿®æ”¹çš„æ–‡ä»¶

1. **DeepRareAgent/graph.py**
   - æ–°å¢ `prepare_for_mdt_node` å‡½æ•°
   - æ›´æ–° `route_after_prediagnosis` è·¯ç”±é€»è¾‘
   - æ›´æ–° `create_main_graph` å›¾ç»“æ„

2. **DeepRareAgent/p01pre_diagnosis_agent.py**
   - ç§»é™¤å¯¹è¯æ€»ç»“ç”Ÿæˆé€»è¾‘
   - ç®€åŒ–è¿”å›å€¼

3. **DeepRareAgent/p02_mdt/nodes.py**
   - å¢å¼ºæ—¥å¿—è¾“å‡ºï¼ˆå·²åœ¨ä¹‹å‰å®Œæˆï¼‰

## éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šå¿«é€Ÿæµ‹è¯•è„šæœ¬

```bash
uv run python test/quick_test_summary.py
```

### æ–¹æ³•2ï¼šé€šè¿‡LangGraph Studio

1. å¯åŠ¨ `uv run langgraph dev`
2. ä¸ç³»ç»Ÿå¯¹è¯ï¼Œè§¦å‘æ·±åº¦è¯Šæ–­
3. æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   [NOTE] [Prepare MDT] æ­£åœ¨ç”Ÿæˆå¯¹è¯æ€»ç»“...
   [PASS] å¯¹è¯æ‘˜è¦ç”Ÿæˆå®Œæˆï¼ˆxxx å­—ç¬¦ï¼‰
   [PASS] æ¥æ”¶åˆ°å¯¹è¯æ€»ç»“ï¼ˆxxx å­—ç¬¦ï¼‰
   ```

### æ–¹æ³•3ï¼šæ£€æŸ¥ä¸“å®¶ç»„åˆå§‹æ¶ˆæ¯

ä¸“å®¶ç»„çš„åˆå§‹æ¶ˆæ¯åº”è¯¥åŒ…å«ï¼š
```
ç ”ç©¶å’Œè®¨è®ºçš„æ‚£è€…ç—…ä¾‹ä¿¡æ¯å¦‚ä¸‹:

ã€æ‚£è€…ä¿¡æ¯ã€‘
...

---

**é¢„è¯Šé—®è¯Šå¯¹è¯æ€»ç»“ï¼š**
ã€å¯¹è¯æ€»ç»“å†…å®¹ã€‘
```

## å…³é”®æ”¹è¿›ç‚¹

[PASS] **è§£å†³äº† Command æ›´æ–°æ—¶åºé—®é¢˜**
- ä¸å†ä¾èµ–é¢„è¯Šæ–­èŠ‚ç‚¹æ•è· `start_diagnosis` å˜åŒ–
- åœ¨ä¸»å›¾å±‚é¢ç»Ÿä¸€å¤„ç†çŠ¶æ€è½¬æ¢

[PASS] **æ˜ç¡®çš„èŒè´£åˆ†ç¦»**
- é¢„è¯Šæ–­èŠ‚ç‚¹ï¼šè´Ÿè´£æ”¶é›†æ‚£è€…ä¿¡æ¯
- prepare_mdt èŠ‚ç‚¹ï¼šè´Ÿè´£ç”Ÿæˆå¯¹è¯æ€»ç»“
- MDT èŠ‚ç‚¹ï¼šè´Ÿè´£ä¸“å®¶è¯Šæ–­

[PASS] **æ›´å¥½çš„å¯ç»´æŠ¤æ€§**
- å¯¹è¯æ€»ç»“ç”Ÿæˆé€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹
- æ—¥å¿—æ›´æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•

[PASS] **é™çº§å¤„ç†**
- å¦‚æœ LLM è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å¯¹è¯æ–‡æœ¬
- å¦‚æœå·²æœ‰æ€»ç»“ï¼Œè·³è¿‡é‡å¤ç”Ÿæˆ

## æœªæ¥ä¼˜åŒ–å»ºè®®

1. **å¢é‡æ›´æ–°æ€»ç»“**
   - å¦‚æœå¯¹è¯å¾ˆé•¿ï¼Œå¯ä»¥åœ¨æ¯è½®å¯¹è¯åå¢é‡æ›´æ–°æ€»ç»“

2. **æ€»ç»“è´¨é‡è¯„ä¼°**
   - æ·»åŠ æ€»ç»“è´¨é‡æ£€æŸ¥ï¼Œç¡®ä¿åŒ…å«å…³é”®ä¿¡æ¯

3. **ç¼“å­˜æœºåˆ¶**
   - å¯¹ç›¸åŒçš„å¯¹è¯å†å²ç¼“å­˜æ€»ç»“ç»“æœ

4. **é…ç½®åŒ–**
   - æ˜¯å¦ç”Ÿæˆæ€»ç»“ã€æ€»ç»“é•¿åº¦ç­‰å‚æ•°å¯é…ç½®
